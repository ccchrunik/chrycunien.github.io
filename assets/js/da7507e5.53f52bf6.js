(self.webpackChunkyingchiaochen_website=self.webpackChunkyingchiaochen_website||[]).push([[9127],{3905:function(e,t,a){"use strict";a.d(t,{Zo:function(){return c},kt:function(){return m}});var n=a(7294);function l(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){l(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,l=function(e,t){if(null==e)return{};var a,n,l={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(l[a]=e[a]);return l}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(l[a]=e[a])}return l}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,l=e.mdxType,r=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=p(a),m=l,k=d["".concat(s,".").concat(m)]||d[m]||u[m]||r;return a?n.createElement(k,o(o({ref:t},c),{},{components:a})):n.createElement(k,o({ref:t},c))}));function m(e,t){var a=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var r=a.length,o=new Array(r);o[0]=d;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:l,o[1]=i;for(var p=2;p<r;p++)o[p]=a[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},5632:function(e,t,a){"use strict";a.r(t),a.d(t,{frontMatter:function(){return i},contentTitle:function(){return s},metadata:function(){return p},toc:function(){return c},default:function(){return d}});var n=a(4034),l=a(9973),r=(a(7294),a(3905)),o=["components"],i={},s="Istio Setup",p={unversionedId:"Cloud/Service-Mesh/Istio/Setup",id:"Cloud/Service-Mesh/Istio/Setup",isDocsHomePage:!1,title:"Istio Setup",description:"Envivronment",source:"@site/docs/Cloud/Service-Mesh/Istio/Setup.md",sourceDirName:"Cloud/Service-Mesh/Istio",slug:"/Cloud/Service-Mesh/Istio/Setup",permalink:"/docs/Cloud/Service-Mesh/Istio/Setup",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Overview",permalink:"/docs/Cloud/Service-Mesh/Istio/Overview"},next:{title:"Istio Traffic",permalink:"/docs/Cloud/Service-Mesh/Istio/Traffic"}},c=[{value:"Envivronment",id:"envivronment",children:[],level:2},{value:"Install Istio",id:"install-istio",children:[],level:2},{value:"Application Setup",id:"application-setup",children:[],level:2},{value:"Enable Ingress traffic",id:"enable-ingress-traffic",children:[],level:2},{value:"Add Custom Traffic Rules",id:"add-custom-traffic-rules",children:[],level:2},{value:"Dashboard",id:"dashboard",children:[],level:2},{value:"Cleanup",id:"cleanup",children:[],level:2},{value:"References",id:"references",children:[],level:2}],u={toc:c};function d(e){var t=e.components,a=(0,l.Z)(e,o);return(0,r.kt)("wrapper",(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"istio-setup"},"Istio Setup"),(0,r.kt)("h2",{id:"envivronment"},"Envivronment"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"minikube"),": v1.23.0"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"Kubernetes"),": v1.22.1"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"Istio"),": v1.11.4")),(0,r.kt)("h2",{id:"install-istio"},"Install Istio"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Install Istio")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ curl -L https://istio.io/downloadIstio | sh -\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Change into the istio directory")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ cd istio-1.11.4\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Update the ",(0,r.kt)("inlineCode",{parentName:"li"},"PATH")," environment variable (you can add the path in ",(0,r.kt)("inlineCode",{parentName:"li"},"~/.zshrc")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"~/.bashrc")," as well)")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ export PATH=$PWD/bin:$PATH\n")),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"Install a demo Istio profile (the basic structure of Istio in the cluster, you can select different profile)")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ istioctl install --set profile=demo -y\n")),(0,r.kt)("ol",{start:5},(0,r.kt)("li",{parentName:"ol"},"Verify installation.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ istioctl verify-install\n")),(0,r.kt)("h2",{id:"application-setup"},"Application Setup"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Enable ",(0,r.kt)("inlineCode",{parentName:"li"},"istio-injection")," label")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl label namespace default istio-injection=enabled\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Install the application")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Check whether each pod has two containers (one is the original container, the other is the sidecar)")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl get pods -A\n")),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"Verify if the application is running")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'$ kubectl exec "$(kubectl get pod -l app=ratings -o jsonpath=\'{.items[0].metadata.name}\')" -c ratings -- curl -sS productpage:9080/productpage | grep -o "<title>.*</title>"\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Note: If something doesn't run correctly, use ",(0,r.kt)("inlineCode",{parentName:"li"},"istioctl analyze")," to find out the problem")),(0,r.kt)("h2",{id:"enable-ingress-traffic"},"Enable Ingress traffic"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Create a gateway (a crd)")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Get istio ingress port and host")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name==\"http2\")].nodePort}')\nexport SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name==\"https\")].nodePort}')\nexport INGRESS_HOST=$(minikube ip)\nexport GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Send traffic to istio ingress gateway")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Method 1\n$ minikube tunnel\n\n# Method 2\n$ minikube addons enable ingress\n")),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"Verify the page")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'# Method 1\n$ curl "http://$GATEWAY_URL/productpage"\n\n# Method 2\n# Copy "http://$GATEWAY_URL/productpage" to the browser\n')),(0,r.kt)("h2",{id:"add-custom-traffic-rules"},"Add Custom Traffic Rules"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Add desination rules (the virtual services had been defined in ",(0,r.kt)("inlineCode",{parentName:"li"},"bookinfo-gateway.yaml"),")")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml\n\n# If using tls\n$ kubectl apply -f samples/bookinfo/networking/destination-rule-all-mtls.yaml\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"After deployed, you will find some errors, it's fine in that it defines some rules that are not used in addition.")),(0,r.kt)("h2",{id:"dashboard"},"Dashboard"),(0,r.kt)("p",null,"Istio provides a Kiali dashboard to better understand the network view."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Install addons (note: these addons are just for demo, not for production)")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl apply -f samples/addons\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Wait for them to be deployed")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl rollout status deployment/kiali -n istio-system\n$ kubectl -n istio-system get svc kiali\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"View the dashbaord")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ istioctl dashboard kiali\n")),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"Continue sending traffic to our application to gather metrics")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'$ while sleep 0.01; do curl -sS "http://$GATEWAY_URL/productpage" &> /dev/null ; done\n')),(0,r.kt)("ol",{start:5},(0,r.kt)("li",{parentName:"ol"},"Select the graph section on the sidebard (you may have to reload several times)")),(0,r.kt)("h2",{id:"cleanup"},"Cleanup"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Remove application-related resources (including gateway, virtual service, ...)")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ ./samples/bookinfo/platform/kube/cleanup.sh \n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Remove istio-related resources")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Remove addons\nkubectl delete -f samples/addons\n\n# Remove namespace and injection label\nkubectl delete namespace istio-system\nkubectl label namespace default istio-injection-\n")),(0,r.kt)("h2",{id:"references"},"References"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://istio.io/latest/docs/setup/getting-started/"},"https://istio.io/latest/docs/setup/getting-started/"))))}d.isMDXComponent=!0}}]);